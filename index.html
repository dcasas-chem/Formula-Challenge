<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Challenge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Lexend -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --theme-color-600: #0284c7; /* sky-600 */
            --theme-color-800: #0369a1; /* sky-800 */
            --theme-gradient-from: #0ea5e9; /* sky-500 */
            --theme-gradient-to: #06b6d4; /* cyan-500 */
            --theme-shadow-color: 'rgba(14, 165, 233, 0.5)';
            --theme-focus-ring-color: #0ea5e9;
            --theme-bg-from: #0ea5e9; /* sky-500 */
            --theme-bg-to: #0891b2;  /* cyan-600 */
        }
        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, var(--theme-bg-from), var(--theme-bg-to));
            color: #1f2937; /* gray-800 */
            transition: background 0.5s ease;
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .selection-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            cursor: pointer;
        }
        .selection-card.selected {
            transform: translateY(-4px);
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            --tw-ring-color: var(--theme-color-600);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        input[type="text"] {
            font-family: 'Lexend', sans-serif;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--theme-gradient-from), var(--theme-gradient-to));
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--theme-shadow-color);
        }
        .category-button-label {
            cursor: pointer; display: inline-block; padding: 0.75rem 1rem;
            border-radius: 0.5rem; border: 1px solid #d1d5db;
            background-color: rgba(255, 255, 255, 0.6); transition: all 0.2s ease;
        }
        .category-button-label:hover { border-color: var(--theme-color-600); }
        .category-button-checkbox:checked + .category-button-label {
            background-color: var(--theme-color-600); color: white;
            border-color: var(--theme-color-600); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .text-theme { color: var(--theme-color-600); }
        .focus\:ring-theme:focus { --tw-ring-color: var(--theme-focus-ring-color); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto glass-container rounded-2xl p-4 sm:p-6">
        
        <div id="main-menu">
            <div class="text-center mb-4">
                <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r tracking-tight">Formula Challenge</h1>
                <p class="text-gray-600 mt-2 text-base md:text-lg">Pon a prueba tus conocimientos de formulación.</p>
            </div>
            <div id="stats-container" class="text-center mb-4 p-4 bg-white/50 rounded-lg border border-gray-200"></div>

            <div>
                <h2 class="text-lg md:text-xl font-semibold text-center text-theme mb-3">1. Elige el tipo de formulación</h2>
                <div class="flex justify-center gap-4" id="formulation-type-selector">
                    <button data-value="inorganic" class="selection-card p-4 w-full bg-gradient-to-br from-sky-500 to-cyan-400 rounded-xl text-white">
                        <h3 class="text-lg md:text-xl font-bold">Inorgánica</h3>
                    </button>
                    <button data-value="organic" class="selection-card p-4 w-full bg-gradient-to-br from-emerald-500 to-lime-500 rounded-xl text-white">
                        <h3 class="text-lg md:text-xl font-bold">Orgánica</h3>
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <h2 class="text-lg md:text-xl font-semibold text-center text-theme mb-3">2. Elige el modo de juego</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="game-mode-selector">
                    <button data-value="formulate" class="selection-card p-4 rounded-xl border border-violet-300 bg-violet-100/80 flex items-center justify-center">
                        <h3 class="text-sm md:text-base font-bold text-violet-800 text-center">Formula el compuesto</h3>
                    </button>
                    <button data-value="name" class="selection-card p-4 rounded-xl border border-pink-300 bg-pink-100/80 flex items-center justify-center">
                        <h3 class="text-sm md:text-base font-bold text-pink-800 text-center">Nombra el compuesto</h3>
                    </button>
                    <button data-value="correct_error" class="selection-card p-4 rounded-xl border border-amber-300 bg-amber-100/80 flex items-center justify-center">
                        <h3 class="text-sm md:text-base font-bold text-amber-800 text-center">Corrige el error</h3>
                    </button>
                    <button data-value="time_trial" class="selection-card p-4 rounded-xl border border-red-300 bg-red-100/80 flex items-center justify-center">
                        <h3 class="text-sm md:text-base font-bold text-red-800 text-center">Juega a contrarreloj</h3>
                    </button>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="continue-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg">Continuar</button>
            </div>
        </div>

        <div id="category-selection-view" class="hidden fade-in"></div>
        <div id="game-view" class="hidden"></div>
        <div id="game-over-view" class="hidden fade-in text-center p-8"></div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATOS ---
        const inorganicCategories = [ { value: 1, text: "Hidruros" }, { value: 2, text: "Óxidos" }, { value: 3, text: "Peróxidos" }, { value: 4, text: "Sales Binarias" }, { value: 5, text: "Hidróxidos" }, { value: 6, text: "Oxoácidos" }, { value: 7, text: "Oxisales" }, { value: 8, text: "Sales Ácidas" }];
        const organicCategories = [ { value: 1, text: "Hidrocarburos" }, { value: 2, text: "Aromáticos y Halogenados" }, { value: 3, text: "Alcoholes y Éteres" }, { value: 4, text: "Aldehídos y Cetonas" }, { value: 5, text: "Ácidos y Ésteres" }, { value: 6, text: "Aminas y Amidas" } ];
        
        const inorganicCompounds = [
            { formula: 'NaH', names: ['Hidruro de sodio'], category: 1, incorrectName: 'Óxido de sodio'},
            { formula: 'LiH', names: ['Hidruro de litio'], category: 1, incorrectName: 'Cloruro de litio'},
            { formula: 'KH', names: ['Hidruro de potasio'], category: 1, incorrectName: 'Hidróxido de potasio'},
            { formula: 'RbH', names: ['Hidruro de rubidio'], category: 1, incorrectName: 'Hidruro de cesio'},
            { formula: 'CsH', names: ['Hidruro de cesio'], category: 1, incorrectName: 'Hidruro de rubidio'},
            { formula: 'BeH2', names: ['Hidruro de berilio', 'Dihidruro de berilio'], category: 1, incorrectName: 'Óxido de berilio'},
            { formula: 'CaH2', names: ['Hidruro de calcio', 'Dihidruro de calcio'], category: 1, incorrectName: 'Hidruro de potasio'},
            { formula: 'MgH2', names: ['Hidruro de magnesio', 'Dihidruro de magnesio'], category: 1, incorrectName: 'Cloruro de magnesio'},
            { formula: 'SrH2', names: ['Hidruro de estroncio', 'Dihidruro de estroncio'], category: 1, incorrectName: 'Sulfuro de estroncio'},
            { formula: 'BaH2', names: ['Hidruro de bario', 'Dihidruro de bario'], category: 1, incorrectName: 'Óxido de bario'},
            { formula: 'AlH3', names: ['Hidruro de aluminio', 'Trihidruro de aluminio'], category: 1, incorrectName: 'Hidróxido de aluminio'},
            { formula: 'GaH3', names: ['Hidruro de galio', 'Trihidruro de galio'], category: 1, incorrectName: 'Óxido de galio'},
            { formula: 'FeH3', names: ['Hidruro de hierro(III)', 'Trihidruro de hierro'], category: 1, incorrectName: 'Hidruro de hierro(II)'},
            { formula: 'FeH2', names: ['Hidruro de hierro(II)', 'Dihidruro de hierro'], category: 1, incorrectName: 'Hidruro de hierro(III)'},
            { formula: 'CuH', names: ['Hidruro de cobre(I)', 'Monohidruro de cobre'], category: 1, incorrectName: 'Hidruro de cobre(II)'},
            { formula: 'CuH2', names: ['Hidruro de cobre(II)', 'Dihidruro de cobre'], category: 1, incorrectName: 'Hidruro de cobre(I)'},
            { formula: 'PbH4', names: ['Hidruro de plomo(IV)', 'Tetrahidruro de plomo'], category: 1, incorrectName: 'Hidruro de plomo(II)'},
            { formula: 'PbH2', names: ['Hidruro de plomo(II)', 'Dihidruro de plomo'], category: 1, incorrectName: 'Hidruro de plomo(IV)'},
            { formula: 'SnH4', names: ['Hidruro de estaño(IV)', 'Tetrahidruro de estaño'], category: 1, incorrectName: 'Hidruro de estaño(II)'},
            { formula: 'SnH2', names: ['Hidruro de estaño(II)', 'Dihidruro de estaño'], category: 1, incorrectName: 'Hidruro de estaño(IV)'},
            { formula: 'AuH3', names: ['Hidruro de oro(III)', 'Trihidruro de oro'], category: 1, incorrectName: 'Hidruro de oro(I)'},
            { formula: 'AuH', names: ['Hidruro de oro(I)', 'Monohidruro de oro'], category: 1, incorrectName: 'Hidruro de oro(III)'},
            { formula: 'HCl', names: ['Cloruro de hidrógeno', 'Ácido clorhídrico'], category: 1, incorrectName: 'Ácido sulfhídrico'},
            { formula: 'HBr', names: ['Bromuro de hidrógeno', 'Ácido bromhídrico'], category: 1, incorrectName: 'Ácido clorhídrico'},
            { formula: 'HF', names: ['Fluoruro de hidrógeno', 'Ácido fluorhídrico'], category: 1, incorrectName: 'Ácido yodhídrico'},
            { formula: 'HI', names: ['Yoduro de hidrógeno', 'Ácido yodhídrico'], category: 1, incorrectName: 'Ácido fluorhídrico'},
            { formula: 'H2S', names: ['Sulfuro de hidrógeno', 'Ácido sulfhídrico'], category: 1, incorrectName: 'Ácido selenhídrico'},
            { formula: 'H2Se', names: ['Seleniuro de hidrógeno', 'Ácido selenhídrico'], category: 1, incorrectName: 'Ácido telurhídrico'},
            { formula: 'H2Te', names: ['Telururo de hidrógeno', 'Ácido telurhídrico'], category: 1, incorrectName: 'Ácido sulfhídrico'},
            { formula: 'NH3', names: ['Amoniaco', 'Trihidruro de nitrógeno'], category: 1, incorrectName: 'Metano'},
            { formula: 'Na2O', names: ['Óxido de sodio'], category: 2, incorrectName: 'Hidruro de sodio'},
            { formula: 'K2O', names: ['Óxido de potasio'], category: 2, incorrectName: 'Sulfuro de potasio'},
            { formula: 'Li2O', names: ['Óxido de litio'], category: 2, incorrectName: 'Hidruro de litio'},
            { formula: 'CaO', names: ['Óxido de calcio'], category: 2, incorrectName: 'Cloruro de calcio'},
            { formula: 'MgO', names: ['Óxido de magnesio'], category: 2, incorrectName: 'Sulfuro de magnesio'},
            { formula: 'BaO', names: ['Óxido de bario'], category: 2, incorrectName: 'Hidruro de bario'},
            { formula: 'Al2O3', names: ['Óxido de aluminio', 'Trióxido de dialuminio'], category: 2, incorrectName: 'Sulfuro de aluminio'},
            { formula: 'Fe2O3', names: ['Óxido de hierro(III)', 'Trióxido de dihierro'], category: 2, incorrectName: 'Óxido de hierro(II)'},
            { formula: 'FeO', names: ['Óxido de hierro(II)', 'Monóxido de hierro'], category: 2, incorrectName: 'Óxido de hierro(III)'},
            { formula: 'CuO', names: ['Óxido de cobre(II)', 'Monóxido de cobre'], category: 2, incorrectName: 'Óxido de cobre(I)'},
            { formula: 'Cu2O', names: ['Óxido de cobre(I)', 'Monóxido de dicobre'], category: 2, incorrectName: 'Óxido de cobre(II)'},
            { formula: 'PbO2', names: ['Óxido de plomo(IV)', 'Dióxido de plomo'], category: 2, incorrectName: 'Óxido de plomo(II)'},
            { formula: 'PbO', names: ['Óxido de plomo(II)', 'Monóxido de plomo'], category: 2, incorrectName: 'Óxido de plomo(IV)'},
            { formula: 'SnO2', names: ['Óxido de estaño(IV)', 'Dióxido de estaño'], category: 2, incorrectName: 'Óxido de estaño(II)'},
            { formula: 'SnO', names: ['Óxido de estaño(II)', 'Monóxido de estaño'], category: 2, incorrectName: 'Óxido de estaño(IV)'},
            { formula: 'ZnO', names: ['Óxido de zinc'], category: 2, incorrectName: 'Sulfuro de zinc'},
            { formula: 'Ag2O', names: ['Óxido de plata'], category: 2, incorrectName: 'Sulfuro de plata'},
            { formula: 'SO3', names: ['Trióxido de azufre', 'Óxido de azufre(VI)'], category: 2, incorrectName: 'Óxido de azufre(IV)'},
            { formula: 'SO2', names: ['Dióxido de azufre', 'Óxido de azufre(IV)'], category: 2, incorrectName: 'Óxido de azufre(VI)'},
            { formula: 'N2O5', names: ['Pentaóxido de dinitrógeno', 'Óxido de nitrógeno(V)'], category: 2, incorrectName: 'Trióxido de dinitrógeno'},
            { formula: 'CO2', names: ['Dióxido de carbono'], category: 2, incorrectName: 'Monóxido de carbono'},
            { formula: 'Cl2O7', names: ['Heptaóxido de dicloro', 'Óxido de cloro(VII)'], category: 2, incorrectName: 'Pentaóxido de dicloro'},
            { formula: 'H2O2', names: ['Peróxido de hidrógeno', 'Agua oxigenada'], category: 3, incorrectName: 'Óxido de dihidrógeno'},
            { formula: 'Na2O2', names: ['Peróxido de sodio'], category: 3, incorrectName: 'Óxido de sodio'},
            { formula: 'K2O2', names: ['Peróxido de potasio'], category: 3, incorrectName: 'Óxido de potasio'},
            { formula: 'Li2O2', names: ['Peróxido de litio'], category: 3, incorrectName: 'Óxido de litio'},
            { formula: 'Rb2O2', names: ['Peróxido de rubidio'], category: 3, incorrectName: 'Óxido de rubidio'},
            { formula: 'Cs2O2', names: ['Peróxido de cesio'], category: 3, incorrectName: 'Óxido de cesio'},
            { formula: 'CaO2', names: ['Peróxido de calcio'], category: 3, incorrectName: 'Óxido de calcio'},
            { formula: 'MgO2', names: ['Peróxido de magnesio'], category: 3, incorrectName: 'Óxido de magnesio'},
            { formula: 'SrO2', names: ['Peróxido de estroncio'], category: 3, incorrectName: 'Óxido de estroncio'},
            { formula: 'BaO2', names: ['Peróxido de bario'], category: 3, incorrectName: 'Óxido de bario'},
            { formula: 'ZnO2', names: ['Peróxido de zinc'], category: 3, incorrectName: 'Óxido de zinc'},
            { formula: 'CdO2', names: ['Peróxido de cadmio'], category: 3, incorrectName: 'Óxido de cadmio'},
            { formula: 'CuO2', names: ['Peróxido de cobre(II)'], category: 3, incorrectName: 'Óxido de cobre(II)'},
            { formula: 'HgO2', names: ['Peróxido de mercurio(II)'], category: 3, incorrectName: 'Óxido de mercurio(II)'},
            { formula: 'Ag2O2', names: ['Peróxido de plata'], category: 3, incorrectName: 'Óxido de plata'},
            { formula: 'NiO2', names: ['Peróxido de níquel(II)'], category: 3, incorrectName: 'Óxido de níquel(II)'},
            { formula: 'FeO2', names: ['Peróxido de hierro(II)'], category: 3, incorrectName: 'Óxido de hierro(II)'},
            { formula: 'CoO2', names: ['Peróxido de cobalto(II)'], category: 3, incorrectName: 'Óxido de cobalto(II)'},
            { formula: 'SnO2', names: ['Peróxido de estaño(IV)'], category: 3, incorrectName: 'Óxido de estaño(IV)'},
            { formula: 'PbO2', names: ['Peróxido de plomo(IV)'], category: 3, incorrectName: 'Óxido de plomo(IV)'},
            { formula: 'NaCl', names: ['Cloruro de sodio'], category: 4, incorrectName: 'Bromuro de sodio'},
            { formula: 'KBr', names: ['Bromuro de potasio'], category: 4, incorrectName: 'Cloruro de potasio'},
            { formula: 'LiF', names: ['Fluoruro de litio'], category: 4, incorrectName: 'Yoduro de litio'},
            { formula: 'CaF2', names: ['Fluoruro de calcio', 'Difluoruro de calcio'], category: 4, incorrectName: 'Cloruro de calcio'},
            { formula: 'MgCl2', names: ['Cloruro de magnesio', 'Dicloruro de magnesio'], category: 4, incorrectName: 'Bromuro de magnesio'},
            { formula: 'BaI2', names: ['Yoduro de bario', 'Diyoduro de bario'], category: 4, incorrectName: 'Fluoruro de bario'},
            { formula: 'AlBr3', names: ['Bromuro de aluminio', 'Tribromuro de aluminio'], category: 4, incorrectName: 'Cloruro de aluminio'},
            { formula: 'FeCl3', names: ['Cloruro de hierro(III)', 'Tricloruro de hierro'], category: 4, incorrectName: 'Cloruro de hierro(II)'},
            { formula: 'FeI2', names: ['Yoduro de hierro(II)', 'Diyoduro de hierro'], category: 4, incorrectName: 'Yoduro de hierro(III)'},
            { formula: 'CuS', names: ['Sulfuro de cobre(II)'], category: 4, incorrectName: 'Sulfuro de cobre(I)'},
            { formula: 'Cu2S', names: ['Sulfuro de cobre(I)'], category: 4, incorrectName: 'Sulfuro de cobre(II)'},
            { formula: 'AgCl', names: ['Cloruro de plata'], category: 4, incorrectName: 'Bromuro de plata'},
            { formula: 'Ag2S', names: ['Sulfuro de plata'], category: 4, incorrectName: 'Óxido de plata'},
            { formula: 'Na2S', names: ['Sulfuro de sodio'], category: 4, incorrectName: 'Óxido de sodio'},
            { formula: 'K2Se', names: ['Seleniuro de potasio'], category: 4, incorrectName: 'Sulfuro de potasio'},
            { formula: 'PbI2', names: ['Yoduro de plomo(II)', 'Diyoduro de plomo'], category: 4, incorrectName: 'Yoduro de plomo(IV)'},
            { formula: 'PbS2', names: ['Sulfuro de plomo(IV)', 'Disulfuro de plomo'], category: 4, incorrectName: 'Sulfuro de plomo(II)'},
            { formula: 'ZnS', names: ['Sulfuro de zinc'], category: 4, incorrectName: 'Óxido de zinc'},
            { formula: 'CdSe', names: ['Seleniuro de cadmio'], category: 4, incorrectName: 'Sulfuro de cadmio'},
            { formula: 'KI', names: ['Yoduro de potasio'], category: 4, incorrectName: 'Cloruro de potasio'},
            { formula: 'NaOH', names: ['Hidróxido de sodio'], category: 5, incorrectName: 'Cloruro de sodio'},
            { formula: 'KOH', names: ['Hidróxido de potasio'], category: 5, incorrectName: 'Óxido de potasio'},
            { formula: 'LiOH', names: ['Hidróxido de litio'], category: 5, incorrectName: 'Hidruro de litio'},
            { formula: 'Ca(OH)2', names: ['Hidróxido de calcio'], category: 5, incorrectName: 'Óxido de calcio'},
            { formula: 'Mg(OH)2', names: ['Hidróxido de magnesio'], category: 5, incorrectName: 'Hidruro de magnesio'},
            { formula: 'Ba(OH)2', names: ['Hidróxido de bario'], category: 5, incorrectName: 'Óxido de bario'},
            { formula: 'Al(OH)3', names: ['Hidróxido de aluminio'], category: 5, incorrectName: 'Óxido de aluminio'},
            { formula: 'Fe(OH)3', names: ['Hidróxido de hierro(III)'], category: 5, incorrectName: 'Hidróxido de hierro(II)'},
            { formula: 'Fe(OH)2', names: ['Hidróxido de hierro(II)'], category: 5, incorrectName: 'Hidróxido de hierro(III)'},
            { formula: 'Cu(OH)2', names: ['Hidróxido de cobre(II)'], category: 5, incorrectName: 'Hidróxido de cobre(I)'},
            { formula: 'CuOH', names: ['Hidróxido de cobre(I)'], category: 5, incorrectName: 'Hidróxido de cobre(II)'},
            { formula: 'Zn(OH)2', names: ['Hidróxido de zinc'], category: 5, incorrectName: 'Óxido de zinc'},
            { formula: 'Cd(OH)2', names: ['Hidróxido de cadmio'], category: 5, incorrectName: 'Sulfuro de cadmio'},
            { formula: 'Pb(OH)4', names: ['Hidróxido de plomo(IV)'], category: 5, incorrectName: 'Hidróxido de plomo(II)'},
            { formula: 'Pb(OH)2', names: ['Hidróxido de plomo(II)'], category: 5, incorrectName: 'Hidróxido de plomo(IV)'},
            { formula: 'Sn(OH)4', names: ['Hidróxido de estaño(IV)'], category: 5, incorrectName: 'Hidróxido de estaño(II)'},
            { formula: 'Sn(OH)2', names: ['Hidróxido de estaño(II)'], category: 5, incorrectName: 'Hidróxido de estaño(IV)'},
            { formula: 'Cr(OH)3', names: ['Hidróxido de cromo(III)'], category: 5, incorrectName: 'Hidróxido de cromo(VI)'},
            { formula: 'Mn(OH)2', names: ['Hidróxido de manganeso(II)'], category: 5, incorrectName: 'Hidróxido de manganeso(IV)'},
            { formula: 'Co(OH)3', names: ['Hidróxido de cobalto(III)'], category: 5, incorrectName: 'Hidróxido de cobalto(II)'},
            { formula: 'H2SO4', names: ['Ácido sulfúrico'], category: 6, incorrectName: 'Ácido sulfuroso'},
            { formula: 'H2SO3', names: ['Ácido sulfuroso'], category: 6, incorrectName: 'Ácido sulfúrico'},
            { formula: 'HNO3', names: ['Ácido nítrico'], category: 6, incorrectName: 'Ácido nitroso'},
            { formula: 'HNO2', names: ['Ácido nitroso'], category: 6, incorrectName: 'Ácido nítrico'},
            { formula: 'H2CO3', names: ['Ácido carbónico'], category: 6, incorrectName: 'Ácido bórico'},
            { formula: 'H3PO4', names: ['Ácido fosfórico'], category: 6, incorrectName: 'Ácido fosforoso'},
            { formula: 'H3PO3', names: ['Ácido fosforoso'], category: 6, incorrectName: 'Ácido fosfórico'},
            { formula: 'HClO4', names: ['Ácido perclórico'], category: 6, incorrectName: 'Ácido clórico'},
            { formula: 'HClO3', names: ['Ácido clórico'], category: 6, incorrectName: 'Ácido perclórico'},
            { formula: 'HClO2', names: ['Ácido cloroso'], category: 6, incorrectName: 'Ácido hipocloroso'},
            { formula: 'HClO', names: ['Ácido hipocloroso'], category: 6, incorrectName: 'Ácido cloroso'},
            { formula: 'HBrO3', names: ['Ácido brómico'], category: 6, incorrectName: 'Ácido perbrómico'},
            { formula: 'HIO3', names: ['Ácido yódico'], category: 6, incorrectName: 'Ácido peryódico'},
            { formula: 'H2CrO4', names: ['Ácido crómico'], category: 6, incorrectName: 'Ácido dicrómico'},
            { formula: 'H2Cr2O7', names: ['Ácido dicrómico'], category: 6, incorrectName: 'Ácido crómico'},
            { formula: 'HMnO4', names: ['Ácido permangánico'], category: 6, incorrectName: 'Ácido mangánico'},
            { formula: 'H2MnO4', names: ['Ácido mangánico'], category: 6, incorrectName: 'Ácido permangánico'},
            { formula: 'H3AsO4', names: ['Ácido arsénico'], category: 6, incorrectName: 'Ácido arsenioso'},
            { formula: 'H3BO3', names: ['Ácido bórico'], category: 6, incorrectName: 'Ácido carbónico'},
            { formula: 'H2SiO3', names: ['Ácido silícico'], category: 6, incorrectName: 'Ácido fosfórico'},
            { formula: 'H2SeO4', names: ['Ácido selénico'], category: 6, incorrectName: 'Ácido selenioso'},
            { formula: 'Na2SO4', names: ['Sulfato de sodio'], category: 7, incorrectName: 'Sulfito de sodio'},
            { formula: 'K2CO3', names: ['Carbonato de potasio'], category: 7, incorrectName: 'Carbonato de sodio'},
            { formula: 'LiNO3', names: ['Nitrato de litio'], category: 7, incorrectName: 'Nitrito de litio'},
            { formula: 'MgSO3', names: ['Sulfito de magnesio'], category: 7, incorrectName: 'Sulfato de magnesio'},
            { formula: 'Ca3(PO4)2', names: ['Fosfato de calcio'], category: 7, incorrectName: 'Fosfito de calcio'},
            { formula: 'Al(NO3)3', names: ['Nitrato de aluminio'], category: 7, incorrectName: 'Nitrito de aluminio'},
            { formula: 'Fe2(SO4)3', names: ['Sulfato de hierro(III)'], category: 7, incorrectName: 'Sulfato de hierro(II)'},
            { formula: 'FeSO4', names: ['Sulfato de hierro(II)'], category: 7, incorrectName: 'Sulfato de hierro(III)'},
            { formula: 'Cu3(PO4)2', names: ['Fosfato de cobre(II)'], category: 7, incorrectName: 'Fosfato de cobre(I)'},
            { formula: 'CuNO3', names: ['Nitrato de cobre(I)'], category: 7, incorrectName: 'Nitrato de cobre(II)'},
            { formula: 'KNO3', names: ['Nitrato de potasio'], category: 7, incorrectName: 'Nitrito de potasio'},
            { formula: 'KNO2', names: ['Nitrito de potasio'], category: 7, incorrectName: 'Nitrato de potasio'},
            { formula: 'AgClO3', names: ['Clorato de plata'], category: 7, incorrectName: 'Perclorato de plata'},
            { formula: 'NaClO4', names: ['Perclorato de sodio'], category: 7, incorrectName: 'Clorato de sodio'},
            { formula: 'KMnO4', names: ['Permanganato de potasio'], category: 7, incorrectName: 'Manganato de potasio'},
            { formula: 'Na2CrO4', names: ['Cromato de sodio'], category: 7, incorrectName: 'Dicromato de sodio'},
            { formula: 'K2Cr2O7', names: ['Dicromato de potasio'], category: 7, incorrectName: 'Cromato de potasio'},
            { formula: 'Ca(ClO)2', names: ['Hipoclorito de calcio'], category: 7, incorrectName: 'Clorito de calcio'},
            { formula: 'Fe(BrO3)2', names: ['Bromato de hierro(II)'], category: 7, incorrectName: 'Perbromato de hierro(II)'},
            { formula: 'Al2(SO4)3', names: ['Sulfato de aluminio'], category: 7, incorrectName: 'Sulfito de aluminio'},
            { formula: 'Pb(SO4)2', names: ['Sulfato de plomo(IV)'], category: 7, incorrectName: 'Sulfato de plomo(II)'},
            { formula: 'NaHCO3', names: ['Hidrogenocarbonato de sodio', 'Bicarbonato de sodio'], category: 8, incorrectName: 'Carbonato de sodio'},
            { formula: 'KHSO4', names: ['Hidrogenosulfato de potasio'], category: 8, incorrectName: 'Sulfato de potasio'},
            { formula: 'Ca(HCO3)2', names: ['Hidrogenocarbonato de calcio'], category: 8, incorrectName: 'Carbonato de calcio'},
            { formula: 'Mg(HCO3)2', names: ['Hidrogenocarbonato de magnesio'], category: 8, incorrectName: 'Carbonato de magnesio'},
            { formula: 'NaH2PO4', names: ['Dihidrogenofosfato de sodio'], category: 8, incorrectName: 'Fosfato de sodio'},
            { formula: 'Na2HPO4', names: ['Hidrogenofosfato de sodio'], category: 8, incorrectName: 'Fosfato de sodio'},
            { formula: 'K2HPO4', names: ['Hidrogenofosfato de potasio'], category: 8, incorrectName: 'Fosfato de potasio'},
            { formula: 'KH2PO4', names: ['Dihidrogenofosfato de potasio'], category: 8, incorrectName: 'Fosfato de potasio'},
            { formula: 'Mg(HSO4)2', names: ['Hidrogenosulfato de magnesio'], category: 8, incorrectName: 'Sulfato de magnesio'},
            { formula: 'LiHSO3', names: ['Hidrogenosulfito de litio'], category: 8, incorrectName: 'Sulfito de litio'},
            { formula: 'NaHSO4', names: ['Hidrogenosulfato de sodio'], category: 8, incorrectName: 'Sulfato de sodio'},
            { formula: 'KHCO3', names: ['Hidrogenocarbonato de potasio'], category: 8, incorrectName: 'Carbonato de potasio'},
            { formula: 'Ca(HSO4)2', names: ['Hidrogenosulfato de calcio'], category: 8, incorrectName: 'Sulfato de calcio'},
            { formula: 'Fe(HSO4)2', names: ['Hidrogenosulfato de hierro(II)'], category: 8, incorrectName: 'Sulfato de hierro(II)'},
            { formula: 'Fe(HCO3)3', names: ['Hidrogenocarbonato de hierro(III)'], category: 8, incorrectName: 'Carbonato de hierro(III)'},
            { formula: 'Al(HSO4)3', names: ['Hidrogenosulfato de aluminio'], category: 8, incorrectName: 'Sulfato de aluminio'},
            { formula: 'CaHPO4', names: ['Hidrogenofosfato de calcio'], category: 8, incorrectName: 'Fosfato de calcio'},
            { formula: 'CuHSO4', names: ['Hidrogenosulfato de cobre(I)'], category: 8, incorrectName: 'Sulfato de cobre(I)'},
            { formula: 'Zn(HCO3)2', names: ['Hidrogenocarbonato de zinc'], category: 8, incorrectName: 'Carbonato de zinc'},
            { formula: 'Mg(H2PO4)2', names: ['Dihidrogenofosfato de magnesio'], category: 8, incorrectName: 'Fosfato de magnesio'},
        ];

        const organicCompounds = [
    // Hidrocarburos (Categoría 1)
    { formula: 'CH4', names: ['Metano'], category: 1, incorrectName: 'Etano' },
    { formula: 'CH3CH3', names: ['Etano'], category: 1, incorrectName: 'Propano' },
    { formula: 'CH3CH2CH3', names: ['Propano'], category: 1, incorrectName: 'Butano' },
    { formula: 'CH3CH2CH2CH3', names: ['Butano'], category: 1, incorrectName: 'Pentano' },
    { formula: 'CH3CH2CH2CH2CH3', names: ['Pentano'], category: 1, incorrectName: 'Hexano' },
    { formula: 'CH3CH2CH2CH2CH2CH3', names: ['Hexano'], category: 1, incorrectName: 'Pentano' },
    { formula: 'CH2=CH2', names: ['Eteno'], category: 1, incorrectName: 'Etino' },
    { formula: 'CH3CH=CH2', names: ['Propeno'], category: 1, incorrectName: 'Buteno' },
    { formula: 'CH3CH=CHCH3', names: ['But-2-eno'], category: 1, incorrectName: 'But-1-eno' },
    { formula: 'CH2=CHCH2CH3', names: ['But-1-eno'], category: 1, incorrectName: 'But-2-eno' },
    { formula: 'CH≡CH', names: ['Etino'], category: 1, incorrectName: 'Eteno' },
    { formula: 'CH3C≡CH', names: ['Propino'], category: 1, incorrectName: 'Butino' },
    { formula: 'CH3C≡CCH3', names: ['But-2-ino'], category: 1, incorrectName: 'But-1-ino' },
    { formula: 'CH3CH2C≡CH', names: ['But-1-ino'], category: 1, incorrectName: 'But-2-ino' },
    { formula: 'C6H12', names: ['Ciclohexano'], category: 1, incorrectName: 'Benceno' },
    { formula: 'CH3(CH2)6CH3', names: ['Octano'], category: 1, incorrectName: 'Heptano' },
    { formula: 'CH3(CH2)8CH3', names: ['Decano'], category: 1, incorrectName: 'Nonano' },
    { formula: 'CH3(CH2)5CH=CH2', names: ['Oct-1-eno'], category: 1, incorrectName: 'Oct-2-eno' },
    { formula: 'CH3CH=CH(CH2)4CH3', names: ['Oct-2-eno'], category: 1, incorrectName: 'Oct-1-eno' },
    { formula: 'CH3(CH2)4C≡CH', names: ['Hept-1-ino'], category: 1, incorrectName: 'Hept-2-ino' },
    { formula: 'C5H10', names: ['Ciclopentano'], category: 1, incorrectName: 'Ciclobutano' },

    // Aromáticos y Halogenados (Categoría 2)
    { formula: 'C6H6', names: ['Benceno'], category: 2, incorrectName: 'Ciclohexano' },
    { formula: 'C6H5CH3', names: ['Metilbenceno', 'Tolueno'], category: 2, incorrectName: 'Etilbenceno' },
    { formula: 'C6H4(CH3)2', names: ['Dimetilbenceno', 'Xileno'], category: 2, incorrectName: 'Etilbenceno' },
    { formula: 'C6H5-Cl', names: ['Clorobenceno'], category: 2, incorrectName: 'Bromobenceno' },
    { formula: 'CHCl3', names: ['Triclorometano', 'Cloroformo'], category: 2, incorrectName: 'Diclorometano' },
    { formula: 'CH3Cl', names: ['Clorometano'], category: 2, incorrectName: 'Cloroetano' },
    { formula: 'CH3CH2Cl', names: ['Cloroetano'], category: 2, incorrectName: 'Clorometano' },
    { formula: 'CH3CH2CH2Cl', names: ['Cloropropano'], category: 2, incorrectName: 'Clorobutano' },
    { formula: 'CH3CH(Cl)CH3', names: ['2-cloropropano'], category: 2, incorrectName: '1-cloropropano' },
    { formula: 'CH3CH2CH2CH2Cl', names: ['Clorobutano'], category: 2, incorrectName: 'Cloropropano' },
    { formula: 'CH2ClCH2Cl', names: ['1,2-dicloroetano'], category: 2, incorrectName: '1,1-dicloroetano' },
    { formula: 'CH3CH2Br', names: ['Brometano'], category: 2, incorrectName: 'Cloroetano' },
    { formula: 'CH3I', names: ['Yodometano'], category: 2, incorrectName: 'Yodoetano' },
    { formula: 'C6H5NO2', names: ['Nitrobenzeno'], category: 2, incorrectName: 'Nitrotolueno' },
    { formula: 'C6H4(NO2)2', names: ['Dinitrobenceno'], category: 2, incorrectName: 'Nitrobenzeno' },
    { formula: 'CH3NO2', names: ['Nitrometano'], category: 2, incorrectName: 'Nitroetano' },
    { formula: 'CH2F2', names: ['Difluorometano'], category: 2, incorrectName: 'Fluorometano' },
    { formula: 'C6H5CH2Cl', names: ['Cloruro de bencilo'], category: 2, incorrectName: 'Clorobenceno' },
    { formula: 'C6H4BrCl', names: ['1-bromo-4-clorobenceno'], category: 2, incorrectName: '2-bromo-1-clorobenceno' },
    { formula: 'C6H4(OH)CH3', names: ['Cresol'], category: 2, incorrectName: 'Fenol' },

    // Alcoholes y Éteres (Categoría 3)
    { formula: 'CH3OH', names: ['Metanol'], category: 3, incorrectName: 'Etanol' },
    { formula: 'CH3CH2OH', names: ['Etanol'], category: 3, incorrectName: 'Propanol' },
    { formula: 'CH3CH2CH2OH', names: ['Propan-1-ol'], category: 3, incorrectName: 'Propan-2-ol' },
    { formula: 'CH3CH(OH)CH3', names: ['Propan-2-ol'], category: 3, incorrectName: 'Propan-1-ol' },
    { formula: 'CH3CH2CH2CH2OH', names: ['Butan-1-ol'], category: 3, incorrectName: 'Butan-2-ol' },
    { formula: 'CH3CH(OH)CH2CH3', names: ['Butan-2-ol'], category: 3, incorrectName: 'Butan-1-ol' },
    { formula: 'CH2(OH)CH(OH)CH2OH', names: ['Propano-1,2,3-triol', 'Glicerol'], category: 3, incorrectName: 'Etanodiol' },
    { formula: 'CH3OCH3', names: ['Metoximetano', 'Dimetiléter'], category: 3, incorrectName: 'Metoxietano' },
    { formula: 'CH3OCH2CH3', names: ['Metoxietano'], category: 3, incorrectName: 'Dietiléter' },
    { formula: 'CH3CH2OCH2CH3', names: ['Dietiléter'], category: 3, incorrectName: 'Metoxietano' },
    { formula: 'C6H5OH', names: ['Fenol'], category: 3, incorrectName: 'Alcohol bencílico' },
    { formula: 'C6H4(OH)2', names: ['Hidroquinona'], category: 3, incorrectName: 'Fenol' },
    { formula: 'C6H5CH2OH', names: ['Alcohol bencílico'], category: 3, incorrectName: 'Fenol' },
    { formula: 'CH2OHCH2OH', names: ['Etano-1,2-diol', 'Glicol'], category: 3, incorrectName: 'Propanodiol' },
    { formula: 'CH3CH2CH2CH2CH2OH', names: ['Pentan-1-ol'], category: 3, incorrectName: 'Pentan-2-ol' },
    { formula: 'CH3CH2(CH3)CHOH', names: ['2-Metilbutan-2-ol'], category: 3, incorrectName: '3-Metilbutan-2-ol' },
    { formula: 'CH3OCH(CH3)2', names: ['Metoxi-isopropano'], category: 3, incorrectName: 'Metoxi-propano' },

    // Aldehídos y Cetonas (Categoría 4)
    { formula: 'HCHO', names: ['Metanal', 'Formaldehído'], category: 4, incorrectName: 'Etanal' },
    { formula: 'CH3CHO', names: ['Etanal'], category: 4, incorrectName: 'Propanal' },
    { formula: 'CH3CH2CHO', names: ['Propanal'], category: 4, incorrectName: 'Butanal' },
    { formula: 'CH3CH2CH2CHO', names: ['Butanal'], category: 4, incorrectName: 'Propanal' },
    { formula: 'CH3COCH3', names: ['Propanona', 'Acetona'], category: 4, incorrectName: 'Butanona' },
    { formula: 'CH3COCH2CH3', names: ['Butanona'], category: 4, incorrectName: 'Propanona' },
    { formula: 'CH3COCH2CH2CH3', names: ['Pentan-2-ona'], category: 4, incorrectName: 'Pentan-3-ona' },
    { formula: 'CH3CH2COCH2CH3', names: ['Pentan-3-ona'], category: 4, incorrectName: 'Pentan-2-ona' },
    { formula: 'C6H5CHO', names: ['Benzaldehído'], category: 4, incorrectName: 'Fenol' },
    { formula: 'CH3(CH2)3CHO', names: ['Pentanal'], category: 4, incorrectName: 'Hexanal' },
    { formula: 'CH3CO(CH2)3CH3', names: ['Hexan-2-ona'], category: 4, incorrectName: 'Hexan-3-ona' },
    { formula: 'CH3CH=CHCHO', names: ['But-2-enal'], category: 4, incorrectName: 'Butan-2-ona' },
    { formula: 'C6H4(CHO)2', names: ['1,2-Bencenodicarbaldehído'], category: 4, incorrectName: '1,3-Bencenodicarbaldehído' },

    // Ácidos y Ésteres (Categoría 5)
    { formula: 'HCOOH', names: ['Ácido metanoico', 'Ácido fórmico'], category: 5, incorrectName: 'Ácido etanoico' },
    { formula: 'CH3COOH', names: ['Ácido etanoico', 'Ácido acético'], category: 5, incorrectName: 'Ácido propanoico' },
    { formula: 'CH3CH2COOH', names: ['Ácido propanoico'], category: 5, incorrectName: 'Ácido butanoico' },
    { formula: 'CH3CH2CH2COOH', names: ['Ácido butanoico'], category: 5, incorrectName: 'Ácido pentanoico' },
    { formula: 'CH3CH2CH2CH2COOH', names: ['Ácido pentanoico'], category: 5, incorrectName: 'Ácido butanoico' },
    { formula: 'CH2(OH)COOH', names: ['Ácido glicólico'], category: 5, incorrectName: 'Ácido acético' },
    { formula: 'HOOC–COOH', names: ['Ácido oxálico'], category: 5, incorrectName: 'Ácido malónico' },
    { formula: 'HOOC–CH2–COOH', names: ['Ácido malónico'], category: 5, incorrectName: 'Ácido oxálico' },
    { formula: 'HOOC–CH2CH2–COOH', names: ['Ácido succínico'], category: 5, incorrectName: 'Ácido malónico' },
    { formula: 'HCOOCH3', names: ['Metanoato de metilo'], category: 5, incorrectName: 'Etanoato de metilo' },
    { formula: 'CH3COOCH3', names: ['Etanoato de metilo'], category: 5, incorrectName: 'Metanoato de metilo' },
    { formula: 'CH3COOCH2CH3', names: ['Etanoato de etilo'], category: 5, incorrectName: 'Etanoato de metilo' },
    { formula: 'CH3CH2COOCH3', names: ['Propanoato de metilo'], category: 5, incorrectName: 'Propanoato de etilo' },
    { formula: 'CH3CH2COOCH2CH3', names: ['Propanoato de etilo'], category: 5, incorrectName: 'Propanoato de metilo' },
    { formula: 'CH3CH2CH2COOCH3', names: ['Butanoato de metilo'], category: 5, incorrectName: 'Butanoato de etilo' },
    { formula: 'C6H5COOH', names: ['Ácido benzoico'], category: 5, incorrectName: 'Ácido fenilacético' },
    { formula: 'C6H5COOCH3', names: ['Benzoato de metilo'], category: 5, incorrectName: 'Benzoato de etilo' },
    { formula: 'CH3(CH2)4COOH', names: ['Ácido hexanoico'], category: 5, incorrectName: 'Ácido pentanoico' },
    { formula: 'HCOOCH2CH3', names: ['Metanoato de etilo'], category: 5, incorrectName: 'Etanoato de etilo' },
    { formula: 'HOOC-C6H4-COOH', names: ['Ácido ftálico'], category: 5, incorrectName: 'Ácido benzoico' },
    { formula: 'CH3CH(OH)COOH', names: ['Ácido láctico'], category: 5, incorrectName: 'Ácido propanoico' },

    // Aminas, Amidas y Nitrilos (Categoría 6)
    { formula: 'CH3NH2', names: ['Metilamina'], category: 6, incorrectName: 'Etilamina' },
    { formula: 'CH3CH2NH2', names: ['Etilamina'], category: 6, incorrectName: 'Propilamina' },
    { formula: 'CH3CH2CH2NH2', names: ['Propilamina'], category: 6, incorrectName: 'Etilamina' },
    { formula: 'CH3NHCH3', names: ['Dimetilamina'], category: 6, incorrectName: 'Trimetilamina' },
    { formula: 'CH3NHCH2CH3', names: ['Etilmetilamina'], category: 6, incorrectName: 'Dietilamina' },
    { formula: '(CH3)3N', names: ['Trimetilamina'], category: 6, incorrectName: 'Dimetilamina' },
    { formula: 'CH3CONH2', names: ['Etanamida'], category: 6, incorrectName: 'Propanamida' },
    { formula: 'CH3CH2CONH2', names: ['Propanamida'], category: 6, incorrectName: 'Butanamida' },
    { formula: 'CH3CH2CH2CONH2', names: ['Butanamida'], category: 6, incorrectName: 'Propanamida' },
    { formula: 'CH3CN', names: ['Acetonitrilo'], category: 6, incorrectName: 'Propanonitrilo' },
    { formula: 'CH3CH2CN', names: ['Propanonitrilo'], category: 6, incorrectName: 'Acetonitrilo' },
    { formula: 'CH3CH2CH2CN', names: ['Butanonitrilo'], category: 6, incorrectName: 'Propanonitrilo' },
    { formula: 'C6H5NH2', names: ['Fenilamina', 'Anilina'], category: 6, incorrectName: 'Nitroanilina' },
    { formula: 'C6H4(NH2)(OH)', names: ['Aminofenol'], category: 6, incorrectName: 'Anilina' },
    { formula: 'CH3CH2CH2CH2NH2', names: ['Butanamina'], category: 6, incorrectName: 'Pentanamina' },
    { formula: 'HCONH2', names: ['Metanamida'], category: 6, incorrectName: 'Etanamida' },
    { formula: 'C6H5CONH2', names: ['Benzamida'], category: 6, incorrectName: 'Fenilamida' },
    { formula: 'C6H5CN', names: ['Benzonitrilo'], category: 6, incorrectName: 'Anilina' }
];

        const themes = {
            inorganic: {
                '--theme-color-600': '#0284c7', '--theme-color-800': '#0369a1', '--theme-gradient-from': '#0ea5e9',
                '--theme-gradient-to': '#06b6d4', '--theme-shadow-color': 'rgba(14, 165, 233, 0.5)', '--theme-focus-ring-color': '#0ea5e9',
                '--theme-bg-from': '#0369a1', '--theme-bg-to': '#0891b2'
            },
            organic: {
                '--theme-color-600': '#16a34a', '--theme-color-800': '#14532d', '--theme-gradient-from': '#22c55e',
                '--theme-gradient-to': '#84cc16', '--theme-shadow-color': 'rgba(34, 197, 94, 0.5)', '--theme-focus-ring-color': '#22c55e',
                '--theme-bg-from': '#15803d', '--theme-bg-to': '#4d7c0f'
            }
        };

        let gameState = {};
        const allViews = {
            mainMenu: document.getElementById('main-menu'),
            categorySelection: document.getElementById('category-selection-view'),
            game: document.getElementById('game-view'),
            gameOver: document.getElementById('game-over-view')
        };
        const mainTitle = document.getElementById('main-title');

        const applyThemeColors = (theme) => Object.entries(themes[theme]).forEach(([key, value]) => document.documentElement.style.setProperty(key, value));
        
        const updateMainMenuTheme = (type) => {
            applyThemeColors(type);
            const titleGradients = {
                inorganic: ['from-sky-600', 'to-cyan-600'],
                organic: ['from-emerald-600', 'to-lime-600']
            };
            mainTitle.className = 'text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r tracking-tight'; // Reset
            mainTitle.classList.add(...titleGradients[type]);
        };

        const showView = (viewToShow) => Object.values(allViews).forEach(v => v.classList.toggle('hidden', v !== viewToShow));
        
        const updateStatsDisplay = () => {
            const stats = JSON.parse(localStorage.getItem('formulaChallengeStats')) || { correct: 0, total: 0 };
            const accuracy = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(1) : 0;
            document.getElementById('stats-container').innerHTML = `<div class="flex items-center justify-center gap-4"><div><h3 class="font-semibold text-gray-800 text-lg">Estadísticas Globales</h3><p class="text-sm text-gray-700">Aciertos: <span class="font-semibold text-green-600">${stats.correct}</span> de <span class="font-semibold text-blue-600">${stats.total}</span> | Precisión: <span class="font-semibold text-yellow-600">${accuracy}%</span></p></div><button id="reset-stats-btn" class="p-2 rounded-full hover:bg-red-500/10" title="Borrar datos"><svg class="w-5 h-5 text-gray-500 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
            document.getElementById('reset-stats-btn').addEventListener('click', () => {
                if (confirm('¿Estás seguro? Se borrarán todas tus estadísticas.')) {
                    localStorage.removeItem('formulaChallengeStats');
                    updateStatsDisplay();
                }
            });
        };
        
        const handleSelection = (selector, selectedBtn) => {
            if (!selectedBtn) return;
            selector.querySelectorAll('.selection-card').forEach(btn => btn.classList.remove('selected'));
            selectedBtn.classList.add('selected');
        };

        document.getElementById('formulation-type-selector').addEventListener('click', e => {
            const card = e.target.closest('.selection-card');
            if (card) {
                handleSelection(e.currentTarget, card);
                updateMainMenuTheme(card.dataset.value);
            }
        });

        document.getElementById('game-mode-selector').addEventListener('click', e => handleSelection(e.currentTarget, e.target.closest('.selection-card')));

        document.getElementById('continue-btn').addEventListener('click', () => {
            const type = document.querySelector('#formulation-type-selector .selected')?.dataset.value;
            const mode = document.querySelector('#game-mode-selector .selected')?.dataset.value;
            if (!type || !mode) {
                alert('Por favor, selecciona el tipo de formulación y el modo de juego.');
                return;
            }
            gameState.type = type;
            gameState.mode = mode;
            const categories = (type === 'inorganic') ? inorganicCategories : organicCategories;
            const isTimeTrial = mode === 'time_trial';
            allViews.categorySelection.innerHTML = `<h2 class="text-3xl font-bold text-theme mb-4">Configura tu partida</h2><div class="flex flex-col items-center gap-8"><div class="w-full"><h3 class="font-bold text-lg text-gray-700 mb-3 text-center">Categorías de compuestos</h3><div class="flex flex-wrap justify-center gap-2 max-w-lg mx-auto" id="category-checkboxes">${categories.map(cat => `<div><input type="checkbox" id="cat-${cat.value}" value="${cat.value}" class="hidden category-button-checkbox"><label for="cat-${cat.value}" class="category-button-label font-medium">${cat.text}</label></div>`).join('')}</div></div>${!isTimeTrial ? `<div><h3 class="font-bold text-lg text-gray-700 mb-3 text-center">Número de preguntas</h3><div class="flex justify-center space-x-3" id="question-count-selector">${[10, 15, 20].map(n => `<button data-value="${n}" class="selection-card w-20 h-14 text-xl font-bold rounded-lg bg-white/60 border">${n}</button>`).join('')}</div></div>` : ''}</div><div class="flex items-center justify-center gap-4 mt-8"><button id="back-to-main-btn" class="text-theme font-semibold flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>Volver</button><button id="start-game-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg">Empezar a jugar</button></div>`;
            if (!isTimeTrial) {
                const qSelector = document.getElementById('question-count-selector');
                qSelector.addEventListener('click', e => handleSelection(qSelector, e.target.closest('.selection-card')));
                qSelector.querySelector('button').classList.add('selected');
            }
            document.getElementById('back-to-main-btn').addEventListener('click', () => showView(allViews.mainMenu));
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            showView(allViews.categorySelection);
        });
        
        let timerInterval;

        const startGame = () => {
            const isTimeTrial = gameState.mode === 'time_trial';
            const count = isTimeTrial ? 999 : parseInt(document.querySelector('#question-count-selector .selected')?.dataset.value);
            const selectedCategories = Array.from(document.querySelectorAll('#category-checkboxes input:checked')).map(cb => parseInt(cb.value));
            if (!count || selectedCategories.length === 0) {
                alert('Por favor, selecciona un número de preguntas y al menos una categoría.');
                return;
            }
            const sourceCompounds = (gameState.type === 'inorganic') ? inorganicCompounds : organicCompounds;
            let questionPool = sourceCompounds.filter(compound => selectedCategories.includes(compound.category));
            if (questionPool.length === 0) {
                 alert('La categoría seleccionada no tiene compuestos. Por favor, elige otra.');
                 return;
            }
            gameState = { ...gameState, totalQuestions: count, currentQuestion: 0, score: 0, questionPool };
            if (isTimeTrial) gameState.timeLeft = 60;
            setupGameView();
            nextQuestion();
        };

        const setupGameView = () => {
            const isTimeTrial = gameState.mode === 'time_trial';
            allViews.game.innerHTML = `<div class="flex items-center justify-between mb-2 text-base"><button id="back-to-menu-btn" class="text-theme hover:text-theme-dark font-semibold flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>Salir</button><div id="game-score" class="font-semibold text-gray-700"></div>${isTimeTrial ? `<div id="timer" class="font-bold text-2xl text-theme"></div>` : ''}</div><div class="w-full bg-gray-200 rounded-full h-2 mb-4"><div id="progress-bar" class="bg-yellow-400 h-2 rounded-full"></div></div><div class="bg-white/50 p-6 rounded-lg text-center border border-gray-200 min-h-[120px] flex flex-col justify-center"><p id="question-text" class="text-gray-600 mb-2 text-lg"></p><p id="challenge" class="text-2xl md:text-3xl font-bold text-theme tracking-wider"></p></div><div class="mt-6"><input id="answer-input" type="text" class="w-full p-4 text-xl text-center rounded-lg border focus:ring-2 focus:ring-theme" placeholder="Tu respuesta..."></div><div id="feedback" class="mt-4 min-h-[70px]"></div><div class="mt-4 flex justify-center"><button id="check-btn" class="btn-primary px-8 py-3 text-white font-semibold rounded-lg w-full md:w-auto text-lg">Comprobar</button></div>`;
            document.getElementById('back-to-menu-btn').addEventListener('click', () => { clearInterval(timerInterval); updateMainMenuTheme(gameState.type); showView(allViews.mainMenu); });
            const checkBtn = document.getElementById('check-btn');
            const answerInput = document.getElementById('answer-input');
            checkBtn.addEventListener('click', () => (checkBtn.textContent === 'Comprobar') ? checkAnswer() : nextQuestion());
            answerInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); checkBtn.click(); }});
            showView(allViews.game);
        };

        const generateError = (compound) => {
            const { formula, names, incorrectName } = compound;
            if (Math.random() > 0.5 && incorrectName) { // Error in name
                return { challenge: `<strong>${formula}</strong> se nombra: <br><em>${incorrectName}</em>`, answer: names[0], type: 'name' };
            } else { // Error in formula
                let wrongFormula = formula.replace(/(\d)/, d => parseInt(d) + 1);
                if (wrongFormula === formula) wrongFormula = formula + '2';
                return { challenge: `<strong>${names[0]}</strong> tiene la fórmula: <br><em>${wrongFormula}</em>`, answer: formula, type: 'formula' };
            }
        };
        
        const nextQuestion = () => {
            if (gameState.currentQuestion >= gameState.totalQuestions) { endGame(); return; }
            const questionData = gameState.questionPool[Math.floor(Math.random() * gameState.questionPool.length)];
            const challengeEl = document.getElementById('challenge');
            const questionTextEl = document.getElementById('question-text');
            if (gameState.mode === 'correct_error') {
                const { challenge, answer, type } = generateError(questionData);
                questionTextEl.textContent = `Hay un error en la ${type === 'name' ? 'nomenclatura' : 'fórmula'}. ¡Corrígelo!`;
                challengeEl.innerHTML = challenge;
                gameState.currentAnswer = answer;
            } else {
                const isFormulateMode = gameState.mode === 'formulate';
                questionTextEl.textContent = isFormulateMode ? 'Escribe la fórmula para:' : 'Nombra el siguiente compuesto:';
                challengeEl.textContent = isFormulateMode ? questionData.names[0] : questionData.formula;
                gameState.currentAnswer = isFormulateMode ? questionData.formula : questionData.names;
            }
            const answerInput = document.getElementById('answer-input');
            answerInput.value = ''; answerInput.disabled = false; answerInput.focus();
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('check-btn').textContent = 'Comprobar';
            if (gameState.mode === 'time_trial' && !timerInterval) startTimer();
            updateGameUI();
            gameState.currentQuestion++;
        };

        const checkAnswer = () => {
            const userAnswer = document.getElementById('answer-input').value.trim().toLowerCase();
            const correctAnswers = Array.isArray(gameState.currentAnswer) ? gameState.currentAnswer.map(name => name.toLowerCase()) : [gameState.currentAnswer.toLowerCase()];
            const isCorrect = correctAnswers.includes(userAnswer);
            if (isCorrect) {
                gameState.score++;
                if (gameState.mode === 'time_trial') gameState.timeLeft += 3;
            } else if (gameState.mode === 'time_trial') {
                gameState.timeLeft -= 2;
            }
            document.getElementById('answer-input').disabled = true;
            document.getElementById('check-btn').textContent = 'Siguiente';
            document.getElementById('feedback').innerHTML = `<div class="p-4 rounded-lg ${isCorrect ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'} border"><h3 class="font-bold ${isCorrect ? 'text-green-800' : 'text-red-800'}">${isCorrect ? '¡Correcto!' : 'Incorrecto'}</h3>${!isCorrect ? `<p class="text-gray-700 mt-1">La respuesta correcta es: <strong class="text-theme">${Array.isArray(gameState.currentAnswer) ? gameState.currentAnswer[0] : gameState.currentAnswer}</strong></p>` : ''}</div>`;
            updateGameUI();
        };

        const startTimer = () => {
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                gameState.timeLeft--;
                timerEl.textContent = `${gameState.timeLeft}s`;
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        };
        
        const updateGameUI = () => {
            if (gameState.mode === 'time_trial') {
                document.getElementById('game-score').textContent = `Aciertos: ${gameState.score}`;
            } else {
                const progress = (gameState.currentQuestion / gameState.totalQuestions) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('game-score').textContent = `Pregunta: ${gameState.currentQuestion} / ${gameState.totalQuestions} | Aciertos: ${gameState.score}`;
            }
        };

        const endGame = () => {
            clearInterval(timerInterval);
            timerInterval = null;
            const stats = JSON.parse(localStorage.getItem('formulaChallengeStats')) || { correct: 0, total: 0 };
            stats.correct += gameState.score;
            stats.total += gameState.mode === 'time_trial' ? gameState.currentQuestion - 1 : gameState.totalQuestions;
            localStorage.setItem('formulaChallengeStats', JSON.stringify(stats));
            allViews.gameOver.innerHTML = `<h2 class="text-3xl font-bold text-theme mb-4">¡Partida Terminada!</h2><p class="text-xl text-gray-700 mb-8">Tu puntuación fue: ${gameState.score} aciertos.</p><button id="play-again-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg">Jugar de Nuevo</button>`;
            document.getElementById('play-again-btn').addEventListener('click', () => { updateMainMenuTheme(gameState.type); showView(allViews.mainMenu); });
            showView(allViews.gameOver);
        };

        const init = () => {
            updateMainMenuTheme('inorganic');
            updateStatsDisplay();
            showView(allViews.mainMenu);
            document.querySelector('#formulation-type-selector [data-value="inorganic"]').classList.add('selected');
            document.querySelector('#game-mode-selector [data-value="formulate"]').classList.add('selected');
        };

        init();
    });
    </script>
</body>
</html>


