<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --grad-from-inorganic: #38bdf8; --grad-to-inorganic: #4f46e5; --focus-ring-inorganic: #60a5fa;
            --grad-from-organic: #4ade80; --grad-to-organic: #16a34a; --focus-ring-organic: #86efac;
            
            --grad-from: var(--grad-from-inorganic); --grad-to: var(--grad-to-inorganic); --focus-ring: var(--focus-ring-inorganic);
        }
        .theme-organic {
             --grad-from: var(--grad-from-organic); --grad-to: var(--grad-to-organic); --focus-ring: var(--focus-ring-organic);
        }
        body {
            font-family: 'Poppins', sans-serif;
            color: #0f172a;
            background-image: linear-gradient(to bottom right, var(--grad-from), var(--grad-to));
            transition: background-image 0.5s ease-in-out;
        }
        .main-card { 
            min-height: 300px; 
            background-color: rgba(255,255,255,0.9);
        }
        #question sub { font-size: 0.6em; vertical-align: sub; }
        .feedback-text sub { font-size: 0.8em; }
        .selection-radio:checked + label {
            border-color: var(--grad-to);
            background-color: color-mix(in srgb, var(--grad-from) 15%, transparent);
            box-shadow: 0 0 0 2px var(--grad-to);
        }
        .themed-text { color: var(--grad-to); }
        .themed-focus-ring:focus{ --tw-ring-color: var(--focus-ring) !important; }
        .progress-bar-inner {
            background: linear-gradient(to right, var(--grad-from), var(--grad-to));
        }
        .bg-gradient-themed {
            background-image: linear-gradient(to right, var(--grad-from), var(--grad-to));
        }
        .text-gradient-themed {
            background-image: linear-gradient(to right, var(--grad-from), var(--grad-to));
            -webkit-background-clip: text;
            color: transparent;
        }
    </style>
</head>
<body class="theme-inorganic flex items-start sm:items-center justify-center min-h-screen p-4 pt-6 sm:p-4">

    <div class="w-full max-w-3xl main-card backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-6 transition-all duration-500">

        <div id="setup-view">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1 text-center text-gradient-themed">Formula Challenge</h1>
            <p class="text-slate-600 mb-6 text-center">Selecciona las opciones para empezar a practicar.</p>
            
            <div class="space-y-6">
                 <div>
                    <h2 class="text-base font-semibold text-slate-700 mb-2 text-center">1. Elige la formulación</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <input type="radio" name="type" value="inorganic" id="type_inorganic" class="hidden selection-radio" checked>
                        <label for="type_inorganic" class="text-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:border-blue-400 transition-all duration-300">
                            <span class="font-semibold text-slate-800">Inorgánica</span>
                        </label>
                        <input type="radio" name="type" value="organic" id="type_organic" class="hidden selection-radio">
                        <label for="type_organic" class="text-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:border-green-400 transition-all duration-300">
                           <span class="font-semibold text-slate-800">Orgánica</span>
                        </label>
                    </div>
                </div>

                <div>
                    <h2 class="text-base font-semibold text-slate-700 mb-2 text-center">2. Elige el modo de práctica</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <input type="radio" name="mode" value="name_formula" id="mode_name" class="hidden selection-radio" checked>
                        <label for="mode_name" class="text-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:border-slate-400 transition-all duration-300">
                            <span class="font-semibold text-slate-800">Nombrar la fórmula</span>
                        </label>
                        <input type="radio" name="mode" value="write_formula" id="mode_write" class="hidden selection-radio">
                        <label for="mode_write" class="text-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:border-slate-400 transition-all duration-300">
                            <span class="font-semibold text-slate-800">Formular el nombre</span>
                        </label>
                        <input type="radio" name="mode" value="find_error" id="mode_error" class="hidden selection-radio">
                        <label for="mode_error" class="text-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:border-slate-400 transition-all duration-300">
                            <span class="font-semibold text-slate-800">Identificar el error</span>
                        </label>
                        <input type="radio" name="mode" value="timed_mode" id="mode_timed" class="hidden selection-radio">
                        <label for="mode_timed" class="text-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:border-slate-400 transition-all duration-300">
                            <span class="font-semibold text-slate-800">Contrarreloj</span>
                        </label>
                    </div>
                </div>
                <div>
                    <h2 class="text-base font-semibold text-slate-700 mb-2 text-center">3. Elige la categoría</h2>
                    <select id="category" class="w-full p-3 border-2 border-slate-300 bg-white rounded-lg focus:ring-2 themed-focus-ring focus:border-transparent transition-all font-medium text-slate-800"></select>
                </div>
            </div>

            <div class="mt-6 flex items-center justify-center gap-2">
                <div id="total-score" class="text-center text-amber-500 font-bold text-base bg-amber-500/10 p-3 rounded-lg flex-grow"></div>
                <button id="reset-score-btn" class="p-3 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500/20 transition-colors" title="Reiniciar puntuación total">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                </button>
            </div>

            <button id="start-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 themed-focus-ring mt-4 shadow-lg bg-gradient-themed">
                Comenzar a Practicar
            </button>
        </div>

        <div id="quiz-view" class="hidden">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 id="quiz-title" class="text-xl sm:text-2xl font-bold text-slate-800"></h1>
                    <p id="quiz-subtitle" class="text-slate-500 mt-1"></p>
                </div>
                 <div class="flex items-center gap-2">
                    <div id="timer" class="text-lg font-bold themed-text hidden"></div>
                    <button id="back-to-setup" class="text-sm bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Salir</button>
                </div>
            </div>
            <!-- Barra de progreso -->
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4">
              <div id="progress-bar" class="progress-bar-inner h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            
            <div class="bg-gradient-to-br from-slate-100 to-slate-200 border border-slate-200 rounded-lg p-4 text-center main-card flex flex-col justify-center shadow-inner">
                <p id="question-label" class="text-sm font-medium themed-text mb-2 tracking-widest"></p>
                <div id="question" class="text-2xl sm:text-3xl font-extrabold text-slate-900 break-words tracking-tight flex items-center justify-center flex-wrap gap-x-4"></div>
            </div>

            <div class="mt-4">
                <div class="flex gap-2">
                    <input type="text" id="answer" placeholder="Escribe tu respuesta aquí..." class="w-full p-3 border-2 border-slate-300 bg-white rounded-lg text-base focus:ring-2 themed-focus-ring focus:border-transparent transition-all" autocomplete="off" spellcheck="false">
                    <button id="hint-btn" class="p-3 bg-sky-500/10 text-sky-500 rounded-lg hover:bg-sky-500/20 transition-colors" title="Pedir una pista">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                    </button>
                </div>
                <div id="feedback" class="mt-2 min-h-[48px] text-center text-slate-600"></div>
                <button id="check-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-4 themed-focus-ring mt-2 shadow-lg bg-gradient-themed">
                    Comprobar
                </button>
            </div>
            
            <div class="text-center mt-3 font-semibold text-slate-600 flex justify-center items-center gap-4">
                <span id="score"></span>
                <span id="streak" class="hidden items-center gap-1 text-orange-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.133 2.533c3.42.533 5.344 3.23 5.344 6.933 0 2.22-1.022 4.228-2.533 5.828-1.583 1.6-2.54 3.195-2.54 4.972h-2.82c0-2.618 1.433-4.633 2.82-6.195C15.42 12.65 16 11.23 16 9.466c0-2.94-1.333-4.89-3.9-5.34L11.133 2.533z"/></svg>
                    <span id="streak-count"></span>
                </span>
            </div>
        </div>
        
        <div id="final-score-view" class="hidden text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-4 text-gradient-themed">¡Prueba finalizada!</h1>
            <p id="final-score-text" class="text-xl text-slate-700 mb-2"></p>
            <p id="final-message" class="text-base text-slate-500 mb-6"></p>
            <!-- Revisión de respuestas -->
            <div id="results-review" class="mt-6 text-left max-h-60 overflow-y-auto border border-slate-200 rounded-lg p-2">
                <h3 class="font-bold text-lg text-slate-800 mb-2 sticky top-0 bg-white/80 p-2">Revisión de respuestas</h3>
                <div id="results-table-container"></div>
            </div>
            <button id="restart-btn" class="w-full max-w-xs mx-auto text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 themed-focus-ring mt-6 shadow-lg bg-gradient-themed">
                Volver a empezar
            </button>
        </div>
    </div>

    <script>
        // --- DATOS ---
        const inorganicCategories = [ { value: 1, text: "1. Hidruros" }, { value: 2, text: "2. Óxidos" }, { value: 3, text: "3. Sales Binarias" }, { value: 4, text: "4. Compuestos Binarios (1-3)" }, { value: 5, text: "5. Hidróxidos" }, { value: 6, text: "6. Oxoácidos" }, { value: 7, text: "7. Oxisales" }, { value: 8, text: "8. Sales Ácidas" }, { value: 9, text: "9. Compuestos Terciarios y Cuaternarios (5-8)" }, { value: 10, text: "10. Todos los compuestos" } ];
        const organicCategories = [ { value: 1, text: "1. Hidrocarburos" }, { value: 2, text: "2. Aromáticos y Derivados Halogenados" }, { value: 3, text: "3. Alcoholes y Éteres" }, { value: 4, text: "4. Aldehídos y Cetonas" }, { value: 5, text: "5. Ácidos carboxílicos y Ésteres" }, { value: 6, text: "6. Aminas, Amidas y Nitroderivados" } ];
        let inorganicCompounds, organicCompounds;

        // --- Carga de datos dinámica desde archivos CSV ---
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';').map(v => v.trim());
                if (values.length !== headers.length) continue;
                const obj = {};
                headers.forEach((header, index) => {
                    if (header === 'names') {
                        obj[header] = values[index].split('|').map(name => name.trim());
                    } else if (header === 'category') {
                        obj[header] = parseInt(values[index], 10);
                    } else {
                        obj[header] = values[index] || undefined;
                    }
                });
                data.push(obj);
            }
            return data;
        };
        
        const loadCompounds = async (type) => {
            try {
                if (type === 'inorganic' && !inorganicCompounds) {
                    const response = await fetch('inorganic_compounds.csv');
                    if (!response.ok) throw new Error(`Network response was not ok for inorganic_compounds.csv`);
                    const csvText = await response.text();
                    inorganicCompounds = parseCSV(csvText);
                } else if (type === 'organic' && !organicCompounds) {
                    const response = await fetch('organic_compounds.csv');
                     if (!response.ok) throw new Error(`Network response was not ok for organic_compounds.csv`);
                    const csvText = await response.text();
                    organicCompounds = parseCSV(csvText);
                }
            } catch (error) {
                console.error('Error al cargar la base de datos de compuestos:', error);
                alert('No se pudo cargar la base de datos. Asegúrate de que los archivos .csv estén en la misma carpeta que el archivo .html.');
            }
        };

        // --- LÓGICA DE LA APLICACIÓN ---
        const body = document.body;
        const setupView = document.getElementById('setup-view');
        const quizView = document.getElementById('quiz-view');
        const finalScoreView = document.getElementById('final-score-view');
        const startBtn = document.getElementById('start-btn');
        const checkBtn = document.getElementById('check-btn');
        const answerInput = document.getElementById('answer');
        const categorySelect = document.getElementById('category');
        const backToSetupBtn = document.getElementById('back-to-setup');
        const restartBtn = document.getElementById('restart-btn');
        const typeRadios = document.querySelectorAll('input[name="type"]');
        const questionEl = document.getElementById('question');
        const totalScoreEl = document.getElementById('total-score');
        const resetScoreBtn = document.getElementById('reset-score-btn');
        const hintBtn = document.getElementById('hint-btn');
        const feedbackEl = document.getElementById('feedback');
        const timerEl = document.getElementById('timer');
        
        let currentCompound = null;
        let quizSessionCompounds = [];
        let score = { correct: 0, total: 0 };
        let state = 'waiting';
        let sessionResults = [];
        let currentStreak = 0;
        let timerInterval;
        const QUIZ_LENGTH = 10;

        const loadTotalScore = () => {
            const totalCorrect = parseInt(localStorage.getItem('totalCorrect')) || 0;
            const totalPlayed = parseInt(localStorage.getItem('totalPlayed')) || 0;
            if (totalPlayed > 0) {
                totalScoreEl.textContent = `Puntuación Total: ${totalCorrect} / ${totalPlayed}`;
            } else {
                totalScoreEl.textContent = '¡Completa tu primera prueba para ver tu puntuación!';
            }
        };

        const saveTotalScore = (correctAnswers, playedQuestions) => {
            let totalCorrect = parseInt(localStorage.getItem('totalCorrect')) || 0;
            let totalPlayed = parseInt(localStorage.getItem('totalPlayed')) || 0;
            totalCorrect += correctAnswers;
            totalPlayed += playedQuestions;
            localStorage.setItem('totalCorrect', totalCorrect);
            localStorage.setItem('totalPlayed', totalPlayed);
        };

        const resetTotalScore = () => {
            localStorage.removeItem('totalCorrect');
            localStorage.removeItem('totalPlayed');
            loadTotalScore();
        };

        const populateCategories = (type) => {
            const categories = type === 'inorganic' ? inorganicCategories : organicCategories;
            categorySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.text;
                categorySelect.appendChild(option);
            });
        };

        const setTheme = (type) => {
            body.classList.remove('theme-inorganic', 'theme-organic');
            body.classList.add(type === 'inorganic' ? 'theme-inorganic' : 'theme-organic');
        };

        const normalizeText = (str) => {
            if (typeof str !== 'string') return '';
            return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+\(/g, '(').replace(/\s*=\s*/g, "=").replace(/\s*≡\s*/g, "≡").replace(/\s*-\s*/g, "-").replace(/,/g, '');
        };
        
        const capitalize = (str) => {
            if (typeof str !== 'string' || str.length === 0) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        };
        
        const renderFormula = (formula) => {
            const simpleRender = (text) => text.replace(/(\d+)/g, '<sub>$1</sub>');
            if (formula === 'C6H6') return `<svg viewBox="0 0 100 100" width="150" height="150"><polygon stroke="currentColor" stroke-width="3" fill="none" points="50,10 93,35 93,85 50,110 7,85 7,35"></polygon><circle cx="50" cy="60" r="20" stroke="currentColor" stroke-width="2" fill="none"></circle></svg>`;
            return simpleRender(formula);
        };
        
        const setupGame = async () => {
            const currentType = document.querySelector('input[name="type"]:checked').value;
            await loadCompounds(currentType);
            
            const allCompounds = currentType === 'inorganic' ? inorganicCompounds : organicCompounds;
            if (!allCompounds) return; 

            const currentMode = document.querySelector('input[name="mode"]:checked').value;
            const currentCategory = parseInt(categorySelect.value);
            const categoryText = categorySelect.options[categorySelect.selectedIndex].text;

            let filteredCompounds;
            
            if (currentMode === 'find_error') {
                 let compoundsWithError = allCompounds.filter(c => c.incorrectName);
                 if (currentType === 'inorganic') {
                    if (currentCategory === 4) compoundsWithError = compoundsWithError.filter(c => [1, 2, 3].includes(c.category));
                    else if (currentCategory === 9) compoundsWithError = compoundsWithError.filter(c => [5, 6, 7, 8].includes(c.category));
                    else if (currentCategory === 10) {}
                    else compoundsWithError = compoundsWithError.filter(c => c.category === currentCategory);
                 } else {
                     compoundsWithError = compoundsWithError.filter(c => c.category === currentCategory);
                 }
                 filteredCompounds = compoundsWithError;
            } else {
                 if (currentType === 'inorganic' && currentCategory === 4) filteredCompounds = allCompounds.filter(c => [1, 2, 3].includes(c.category));
                else if (currentType === 'inorganic' && currentCategory === 9) filteredCompounds = allCompounds.filter(c => [5, 6, 7, 8].includes(c.category));
                else if (currentType === 'inorganic' && currentCategory === 10) filteredCompounds = [...allCompounds];
                else filteredCompounds = allCompounds.filter(c => c.category === currentCategory);
            }
            
            // Se baraja la lista filtrada para asegurar un orden aleatorio en cada prueba.
            let shuffled = [...filteredCompounds].sort(() => 0.5 - Math.random());
            
            // Se seleccionan los primeros N compuestos de la lista barajada.
            // El método 'slice' crea un nuevo array con los compuestos, garantizando que no se repitan dentro de la misma prueba.
            quizSessionCompounds = shuffled.slice(0, QUIZ_LENGTH);

            if (quizSessionCompounds.length === 0) {
                 alert("No hay suficientes compuestos en esta categoría para este modo de juego.");
                 return;
            }
            
            if (quizSessionCompounds.length < QUIZ_LENGTH) {
                console.warn(`Advertencia: Solo se encontraron ${quizSessionCompounds.length} compuestos. La prueba será más corta.`)
            }

            score = { correct: 0, total: 0 };
            sessionResults = [];
            currentStreak = 0;
            updateStreak();
            updateScore();
            
            const titles = {
                name_formula: 'Nombra el siguiente compuesto:',
                write_formula: 'Formula el siguiente compuesto:',
                find_error: 'Identifica el error y escribe el nombre correcto:',
                timed_mode: '¡Rápido! Nombra el compuesto:'
            };
            const labels = {
                name_formula: 'FÓRMULA', write_formula: 'NOMBRE', find_error: 'FÓRMULA Y NOMBRE INCORRECTO', timed_mode: 'FÓRMULA'
            }

            document.getElementById('quiz-title').textContent = categoryText;
            document.getElementById('quiz-subtitle').textContent = titles[currentMode];
            document.getElementById('question-label').textContent = labels[currentMode];
            
            if (currentMode === 'timed_mode') startTimer();
            else timerEl.classList.add('hidden');

            setupView.classList.add('hidden');
            finalScoreView.classList.add('hidden');
            quizView.classList.remove('hidden');
            nextQuestion();
        };
        
        const nextQuestion = () => {
            updateProgressBar();
            if (score.total >= quizSessionCompounds.length) {
                showFinalScore();
                return;
            }

            state = 'waiting';
            checkBtn.textContent = 'Comprobar';
            checkBtn.disabled = false;
            feedbackEl.innerHTML = '';
            answerInput.value = '';
            answerInput.disabled = false;
            answerInput.focus();
            hintBtn.disabled = false;

            currentCompound = quizSessionCompounds[score.total];
            const currentMode = document.querySelector('input[name="mode"]:checked').value;

            if (currentMode === 'name_formula' || currentMode === 'timed_mode') {
                questionEl.innerHTML = renderFormula(currentCompound.formula);
            } else if (currentMode === 'write_formula') {
                questionEl.innerHTML = `<span>${capitalize(currentCompound.names[0])}</span>`;
            } else if (currentMode === 'find_error') {
                questionEl.innerHTML = `${renderFormula(currentCompound.formula)} <span class="text-red-500 font-medium ml-2">${capitalize(currentCompound.incorrectName)}</span>`;
            }
        };

        const checkAnswer = () => {
            if (!answerInput.value.trim()) return;
            const currentMode = document.querySelector('input[name="mode"]:checked').value;
            const userAnswer = answerInput.value.trim();
            let isCorrect = false;
            
            if (currentMode === 'write_formula') {
                isCorrect = (normalizeText(userAnswer) === normalizeText(currentCompound.formula));
            } else { 
                const userNormalized = normalizeText(userAnswer);
                isCorrect = currentCompound.names.some(name => normalizeText(name) === userNormalized);
            }
            
            score.total++;
            let explanationHTML = '';
            
            if (isCorrect) {
                score.correct++;
                currentStreak++;
                feedbackEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-green-600 font-bold"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"></path></svg><span>¡Correcto!</span></div>`;
            } else {
                currentStreak = 0;
                let correctAnswerHTML = (currentMode === 'write_formula')
                    ? currentCompound.formula
                    : capitalize(currentCompound.names[0]);
                if (currentCompound.explanation) {
                    explanationHTML = `<p class="text-sm mt-1 text-sky-600">${currentCompound.explanation}</p>`;
                }
                feedbackEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-red-600 font-bold"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg><span>Incorrecto.</span></div><p class="text-sm feedback-text">La respuesta correcta es: <strong>${correctAnswerHTML}</strong></p>${explanationHTML}`;
            }

            sessionResults.push({
                question: currentCompound,
                userAnswer: userAnswer,
                isCorrect: isCorrect
            });
            
            updateScore();
            updateStreak();
            state = 'checked';
            checkBtn.textContent = score.total >= quizSessionCompounds.length ? 'Ver Resultados' : 'Siguiente';
            answerInput.disabled = true;
            hintBtn.disabled = true;
        };
        
        const showFinalScore = () => {
            clearInterval(timerInterval);
            updateProgressBar();
            const totalQuestions = quizSessionCompounds.length;
            document.getElementById('final-score-text').textContent = `Tu nota final es: ${score.correct} sobre ${totalQuestions}`;
            let message = '';
            const percentage = totalQuestions > 0 ? (score.correct / totalQuestions) * 100 : 0;
            if (percentage < 50) message = 'Necesitas repasar un poco más. ¡No te rindas!';
            else if (percentage < 80) message = '¡Buen trabajo! Sigue practicando para perfeccionar.';
            else message = '¡Excelente! Tienes un gran dominio del tema.';
            document.getElementById('final-message').textContent = message;

            saveTotalScore(score.correct, score.total);
            renderResultsTable();
            quizView.classList.add('hidden');
            finalScoreView.classList.remove('hidden');
        };

        const updateScore = () => {
            const totalQuestions = quizSessionCompounds.length;
            document.getElementById('score').textContent = `Pregunta: ${score.total + 1} / ${totalQuestions}`;
        };
        
        const updateProgressBar = () => {
            const progress = (score.total / quizSessionCompounds.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        };

        const updateStreak = () => {
            const streakEl = document.getElementById('streak');
            if(currentStreak > 1) {
                streakEl.classList.remove('hidden');
                streakEl.classList.add('flex');
                document.getElementById('streak-count').textContent = currentStreak;
            } else {
                streakEl.classList.add('hidden');
            }
        };

        const startTimer = () => {
            let timeLeft = 180; // 3 minutos
            timerEl.classList.remove('hidden');

            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    showFinalScore();
                }
                timeLeft--;
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        };
        
        const renderResultsTable = () => {
            const container = document.getElementById('results-table-container');
            let tableHTML = `<table class="w-full text-sm"><thead><tr class="border-b"><th class="p-2 text-left">Pregunta</th><th class="p-2 text-left">Tu Respuesta</th><th class="p-2 text-left">Correcta</th></tr></thead><tbody>`;
            sessionResults.forEach(result => {
                const mode = result.question.incorrectName ? 'find_error' : (document.querySelector('input[name="mode"]:checked').value);
                
                let questionText = '';
                if(mode === 'write_formula') questionText = capitalize(result.question.names[0]);
                else if (mode === 'find_error') questionText = `${renderFormula(result.question.formula)} <span class="text-red-500 font-medium">${capitalize(result.question.incorrectName)}</span>`;
                else questionText = renderFormula(result.question.formula);

                const correctAnswer = (mode === 'write_formula') ? result.question.formula : capitalize(result.question.names[0]);
                const isCorrectClass = result.isCorrect ? 'text-green-600' : 'text-red-600';

                tableHTML += `<tr class="border-b"><td class="p-2 font-mono">${questionText}</td><td class="p-2 ${isCorrectClass}">${result.userAnswer || '-'}</td><td class="p-2 text-slate-500">${correctAnswer}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        };

        // --- INICIALIZACIÓN Y EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            populateCategories('inorganic');
            loadTotalScore();
        });

        resetScoreBtn.addEventListener('click', resetTotalScore);

        typeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            setTheme(e.target.value);
            populateCategories(e.target.value);
        }));

        startBtn.addEventListener('click', setupGame);
        restartBtn.addEventListener('click', () => {
            finalScoreView.classList.add('hidden');
            setupView.classList.remove('hidden');
            loadTotalScore();
        });
        backToSetupBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            quizView.classList.add('hidden');
            setupView.classList.remove('hidden');
            loadTotalScore();
        });

        hintBtn.addEventListener('click', () => {
            if (currentCompound && currentCompound.hint) {
                feedbackEl.innerHTML = `<p class="text-sky-600">${currentCompound.hint}</p>`;
                hintBtn.disabled = true;
            } else {
                feedbackEl.innerHTML = `<p class="text-slate-500">No hay pistas disponibles para este compuesto.</p>`;
                hintBtn.disabled = true;
            }
        });

        checkBtn.addEventListener('click', () => {
            if (state === 'waiting') {
                checkAnswer();
            } else {
                nextQuestion();
            }
        });
        
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkBtn.click();
            }
        });
    </script>
</body>
</html>

